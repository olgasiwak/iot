
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.4.2, mkdocs-material-8.5.10">
    
    
      
        <title>Generator - IoT Dokumentacja projektu</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.975780f9.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.2505c338.min.css">
        
      
      

    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../assets/_mkdocstrings.css">
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="None" data-md-color-accent="None">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#generator" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="IoT Dokumentacja projektu" class="md-header__button md-logo" aria-label="IoT Dokumentacja projektu" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            IoT Dokumentacja projektu
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Generator
            
          </span>
        </div>
      </div>
    </div>
    
    
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="IoT Dokumentacja projektu" class="md-nav__button md-logo" aria-label="IoT Dokumentacja projektu" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    IoT Dokumentacja projektu
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        Inteligentne oświetlenie miasta
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../responsibilities/" class="md-nav__link">
        Podział pracy
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../collector_executor_documentation/" class="md-nav__link">
        Collector Executor
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../data2metric_documentation/" class="md-nav__link">
        Data2Metric
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../discoverer_documentation/" class="md-nav__link">
        Discovery
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../guardian_documentation/" class="md-nav__link">
        Guardain
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../grafana_documentation/" class="md-nav__link">
        Grafana
      </a>
    </li>
  

    
      
      
      

  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Generator
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        Generator
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#wagi-parametrow" class="md-nav__link">
    Wagi parametrów
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#flagi-narzedzia" class="md-nav__link">
    Flagi narzędzia
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#funkcje-w-kodzie-generatora" class="md-nav__link">
    Funkcje w kodzie generatora
  </a>
  
    <nav class="md-nav" aria-label="Funkcje w kodzie generatora">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#def-parse_args" class="md-nav__link">
    def parse_args()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#def-load_conditions" class="md-nav__link">
    def load_conditions()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#def-determine_weightsargs-conditions" class="md-nav__link">
    def determine_weights(args, conditions)
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#def-updata_statesstates-sensor-choice" class="md-nav__link">
    def updata_states(STATES, sensor, choice)
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#def-display_statesstates" class="md-nav__link">
    def display_states(STATES)
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#def-start_simulatorclient-conditions-weight-states" class="md-nav__link">
    def start_simulator(client, conditions, weight, STATES)
  </a>
  
    <nav class="md-nav" aria-label="def start_simulator(client, conditions, weight, STATES)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#def-on_connect-orad-on_message" class="md-nav__link">
    def on_connect orad on_message
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#def-main" class="md-nav__link">
    def main()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#konfiguracja" class="md-nav__link">
    Konfiguracja
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#wagi-parametrow" class="md-nav__link">
    Wagi parametrów
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#flagi-narzedzia" class="md-nav__link">
    Flagi narzędzia
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#funkcje-w-kodzie-generatora" class="md-nav__link">
    Funkcje w kodzie generatora
  </a>
  
    <nav class="md-nav" aria-label="Funkcje w kodzie generatora">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#def-parse_args" class="md-nav__link">
    def parse_args()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#def-load_conditions" class="md-nav__link">
    def load_conditions()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#def-determine_weightsargs-conditions" class="md-nav__link">
    def determine_weights(args, conditions)
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#def-updata_statesstates-sensor-choice" class="md-nav__link">
    def updata_states(STATES, sensor, choice)
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#def-display_statesstates" class="md-nav__link">
    def display_states(STATES)
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#def-start_simulatorclient-conditions-weight-states" class="md-nav__link">
    def start_simulator(client, conditions, weight, STATES)
  </a>
  
    <nav class="md-nav" aria-label="def start_simulator(client, conditions, weight, STATES)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#def-on_connect-orad-on_message" class="md-nav__link">
    def on_connect orad on_message
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#def-main" class="md-nav__link">
    def main()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#konfiguracja" class="md-nav__link">
    Konfiguracja
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


<h1 id="generator">Generator</h1>
<p>Aby wygenerować sztuczny ruch pieszych dla więcej niż jednego sensora, przygotowany został generator ruchu,
osadzony na hoście <code>client2</code>. Jest to narzędzie wywoływane z linii komend CLI, któremu zadajemy parametr pogody, pory roku oraz pory dnia. </p>
<p>Podgląd możliwych do wywołania parametrów:</p>
<pre><code class="language-bash">python3 traffic_simulator.py --help
usage: Parse parameters to determine possible traffic [-h] [--best | --worst]
                                                      [{autumn,winter,spring,summer,default}]
                                                      [{morning,dusk,evening,night,default}]
                                                      [{windy,rainy,snowy,cloudy,default}]

positional arguments:
  {autumn,winter,spring,summer,default}
                        Season of the year
  {morning,dusk,evening,night,default}
                        Time of the day
  {windy,rainy,snowy,cloudy,default}
                        Present weather

optional arguments:
  -h, --help            show this help message and exit
  --best                Best possible conditions
  --worst               Worst possible conditions
  --rate                Set custom rate of detection
</code></pre>
<p>Podając warunki opisane w komendzie uzyskujemy wartość na podstawie której obliczamy prawdopodobieństwo wylosowania <code>1</code> (w danym oknie czasowym pieszy przeszedł pod czujnikiem ruchu, co spowodowało rozświetlenie latarnii do poziomu zadanego przez użytkownika). Następnie na podstawie wylosowanego prawdopodobieństwa obliczamy prawdopodobieństwo wylosowania <code>0</code> (czujka nie wykryła ruchu). Jest to prosty rachunek <code>1 - P(1)</code>.</p>
<h2 id="wagi-parametrow">Wagi parametrów</h2>
<p>Wagi poszczególnych parametrów pogody, pory roku oraz pory dnia zostały podane w pliku <code>weights.yaml</code> i wyglądają następująco:</p>
<pre><code class="language-yaml">season:
  winter: 1
  autumn: 2
  spring: 4
  summer: 5
  default: 3

daytime:
  night: 1
  dusk: 2
  morning: 4
  evening: 5
  default: 3

weather:
  rainy: 1
  snowy: 2
  windy: 4
  cloudy: 5
  default: 3
</code></pre>
<p>Jest to zwykły plik w formacie YAML (Yet Another Markup Language), który zawiera wagi z zakresu <code>1-5</code>. Waga <code>3</code> została zarezerwowana dla parametru <code>default</code>, który występuje wtedy, kiedy użytkownik nie zadał danego parametru na wejściu programu. Im większa waga, tym większe prawdopodobieństwo wystąpienia pieszego, z tego powodu na przykład pora roku <code>summer</code> ma większą wagę niż pora roku <code>winter</code>.</p>
<p>Prawdopodobieństwo wystąpienia <code>1</code> przeliczane jest w następujący sposób:</p>
<pre><code>suma wag / 18 (a tak właściwie liczba parametrów * 6)
</code></pre>
<p>Za pomocą sumy wag nie jesteśmy w stanie osiągnąć prawdopodobieństwa wystąpienia <code>1</code> równego 1. Jest to zabieg celowy, ponieważ nie zakładamy sytuacji, że lampa będzie cały czas rozświetlona, co oznaczałoby, że cały czas przechodzą pod nią piesi (niezależnie od pory dnia czy roku). Tak samo z wartością 0, zakładamy, że zawsze jest możliwość pojawienia się pieszego.</p>
<h2 id="flagi-narzedzia">Flagi narzędzia</h2>
<p>Aby osiągnąć prawdopodobieństwo równe 1, został zaprojektowany przełącznik <code>--rate</code>, który pozwala ustawić dowolne prawdopodobieństwo z przedziału <code>&lt;0;1&gt;</code>.</p>
<p>Zaprojektowano również przełączniki <code>--best</code> i <code>--worst</code>, które generują warunku najlepsze i najgorsze warunki zadane parametrami. Ułatwia to testowanie, ponieważ możemy pominąć wpisywanie wielu parametrów, zastępując je jedną flagą.</p>
<h2 id="funkcje-w-kodzie-generatora">Funkcje w kodzie generatora</h2>
<p>Implementacja rozwiązania wymagana stworzenia następujących funkcji w języku Python3.</p>
<h3 id="def-parse_args">def parse_args()</h3>
<p>Funkcja pobierająca argumenty z wiersza poleceń oraz zwracająca ich wartości do programu.</p>
<pre><code class="language-python">def parse_args():
    parser = ArgumentParser('Parse parameters to determine possible traffic')
    group = parser.add_mutually_exclusive_group(required=False)
    parser.add_argument(
            'season',
            choices=['autumn', 'winter', 'spring', 'summer', 'default'],
            help='Season of the year',
            default='default',
            nargs='?',
            type=str
            )
    ...
    return parser.parse_args()
</code></pre>
<h3 id="def-load_conditions">def load_conditions()</h3>
<p>Funkcja wczytująca plik YAML z wagami, łapiąca wyjątki oraz zwracająca jego zparsowaną wersję w formie słownika dla programu.</p>
<pre><code class="language-python">def load_conditions():
    with open(config.WEIGHTS_FILE, 'r') as weights_file:
        try:
            return yaml.safe_load(weights_file)
        except YAMLError as error:
            print(error)
</code></pre>
<h3 id="def-determine_weightsargs-conditions">def determine_weights(args, conditions)</h3>
<p>Funkcja ustalająca sumę wag podanych na wejściu programu przez użytkownika.</p>
<pre><code class="language-python">def determine_weight(args, conditions):
    weight = 0
    if args.worst:
        return len(conditions)
    elif args.best:
        return 5 * len(conditions)
    elif args.rate:
        if 0 &lt;= args.rate &lt;= 1:
            return args.rate * 6 * len(conditions)
        else:
            raise ValueError(&quot;Rate has to be in range 0-1&quot;)
    else:
        for condition in conditions:
            weight += conditions[condition][eval(f'args.{condition}')]
    return weight
</code></pre>
<h2 id="def-updata_statesstates-sensor-choice">def updata_states(STATES, sensor, choice)</h2>
<p>Funkcja przygotowująca wartości (stany czujnika) <code>1</code> i <code>0</code> do wysłania do brokera MQTT oraz zliczająca statystyki.</p>
<pre><code class="language-python">def update_states(STATES, sensor, choice):
    if sensor not in STATES:
        STATES[sensor] = choice
        STATES[f'current{sensor}'] = choice
    else:
        STATES[sensor] += choice
        STATES[f'current{sensor}'] = choice
    return STATES
</code></pre>
<h2 id="def-display_statesstates">def display_states(STATES)</h2>
<p>Funkcja wyświetlająca na STDOUT informacje o danej iteracji generowania danych. Stosuje kolorowe wyświetlanie stanów.</p>
<pre><code class="language-python">def display_states(STATES):
    print('\033[92m' + 50*'-' + '\n')
    for i in range(config.NUMBER_OF_SENSORS):
        print('\033[91m' +
                f'Current state of sensor number {i}: ' +
                str(STATES[f'current{i}']) +
                '\033[0m')
        print('\033[91m' +
                f'Sum of pedestrians detected by sensor number {i}: ' +
                str(STATES[i]) +
                '\033[0m')
        print(10*'-')
    print('\n')
</code></pre>
<h2 id="def-start_simulatorclient-conditions-weight-states">def start_simulator(client, conditions, weight, STATES)</h2>
<p>Funkcja startująca symulację, losująca wartości stanu oraz wysyłająca wiadomości co 4 sekundy do broketa MQTT.</p>
<pre><code class="language-python">def start_simulator(client, conditions, weight, STATES):
    tmp = weight
    while True:
        for i in range(config.NUMBER_OF_SENSORS):
            if i in config.DESOLATED_SENSORS:
                weight /= 2
            choice = choices([1, 0],
                    weights = [(weight/(2*3*len(conditions))),
                    1 - (weight/(3*2*len(conditions)))])[0]
            STATES = update_states(STATES, i, choice)
            client.publish(f&quot;{config.SIMULATOR_SENSORS_PATTERN}{i}&quot;, choice)
            weight = tmp
        display_states(STATES)
        time.sleep(4)
</code></pre>
<h3 id="def-on_connect-orad-on_message">def on_connect orad on_message</h3>
<p>Funkcje znane z collectora_execurota, doimplementowane do połączenia z brokerem MQTT.</p>
<h3 id="def-main">def main()</h3>
<p>Funkcja główna, wywoływana przez program, nawiązuje połączenie z brokerem, losuje wagi i zaczyna symulację.</p>
<pre><code class="language-python">def main():
    args = parse_args()
    client = mqtt.Client()
    client.on_connect = on_connect
    client.on_message = on_message
    client.username_pw_set('admin-user', 'password')
    client.connect(
            config.MQTT_ADDRESS,
            config.MQTT_PORT,
            config.MQTT_TIMEOUT
            )
    conditions = load_conditions()
    weight = determine_weight(args, conditions)

    start_simulator(client,conditions, weight, STATES)
</code></pre>
<h2 id="konfiguracja">Konfiguracja</h2>
<p>Narzędzie zawiera plik konfiguracyjny zawierający następujące parametry:</p>
<ul>
<li><code>MQTT_ADDRESS</code> - Adres brokera MQTT</li>
<li><code>MQTT_PORT</code> - Port na którym uruchomiony jest broker MQTT</li>
<li><code>MQTT_TIMEOUT</code> - Wartość limitu czasu utrzymania aktywności dla klienta</li>
<li><code>SIMULATOR_SENSORS_PATTERN</code> - Regexp nazw topiców na które publikuje generator</li>
<li><code>WEIGHTS_FILE</code> - Plik zawierający wagi</li>
<li><code>NUMBER_OF_SENSORS</code> - Liczba sensorów dla których będziemy generować ruch</li>
<li><code>DESOLATED_SENSORS</code> - Lista sensorów dla których zaniżymy generowany ruch, mogą "symulować" sensory zepsute</li>
</ul>





                
              </article>
            </div>
          
          
        </div>
        
      </main>
      
        <footer class="md-footer">
  
    
    <nav class="md-footer__inner md-grid" aria-label="Footer" >
      
        
        <a href="../grafana_documentation/" class="md-footer__link md-footer__link--prev" aria-label="Previous: Grafana" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Previous
              </span>
              Grafana
            </div>
          </div>
        </a>
      
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "..", "features": [], "search": "../assets/javascripts/workers/search.16e2a7d4.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version.title": "Select version"}}</script>
    
    
      <script src="../assets/javascripts/bundle.5a2dcb6a.min.js"></script>
      
    
    
  </body>
</html>